cpr_get_prostitute_effect = {
	# Find an existing prostitute character
	clear_saved_scope = $PROSTITUTE$
	random_pool_character = {
		province = $LOCATION$
		limit = {
			carn_is_prostitute_trigger = yes
			carn_is_working_as_prostitute_trigger = yes
			carn_can_have_sex_trigger = yes
			$CHARACTER$ = {
				is_attracted_to_gender_of = prev
			}
		}
		save_scope_as = $PROSTITUTE$
	}
	if = {
		limit = {
			NOT = { exists = scope:$PROSTITUTE$ }
		}

		# Create a new prostitute character
		$CHARACTER$ = {
			save_temporary_scope_as = attraction_check
		}
		create_character = {
			template = cpr_prostitute_character_template
			location = $LOCATION$
			gender_female_chance = cpr_attraction_based_female_chance
			dynasty = none
			culture = $LOCATION$.culture
			faith = $LOCATION$.faith
			save_temporary_scope_as = new_character
		}
		scope:new_character = {
			cpr_set_prostitute_sexuality_effect = { CHARACTER = $CHARACTER$ }
			save_scope_as = $PROSTITUTE$
		}
	}
}

# Makes the scoped character a proper prostitute, to be used in after_creation or
# right after character creation
cpr_make_prostitute_effect = {
	# Set event for carn_on_start_working_as_prostitute
	save_scope_value_as = { name = cpr_event value = flag:after_creation }

	# Set origin for debugging
	set_variable = {
		name = cpr_origin
		value = flag:$ORIGIN$
	}

	# Output debug message
	cpr_debug_log_effect = { MSG = cpr_debug_msg_creating_prostitute }

	# Add traits
	cpr_add_prostitute_traits_effect = yes

	# Set sexuality
	cpr_set_prostitute_sexuality_effect = { CHARACTER = root }

	# Start working as prostitute
	carn_start_working_as_prostitute_effect = yes

	# Potentially contract STD
	cpr_prostitute_contract_std_effect = yes

	# Lose piety level if prostitution is not accepted
	if = {
		limit = { carn_accepts_prostitution_trigger = no }
		add_piety_level = -1
	}

	# Prevent pruning
	set_variable = {
		name = last_visited_ruler
		value = dummy_female
		days = 1825
	}

	# Set decision cooldown
	add_character_flag = {
		flag = cpr_decision_cooldown
		years = 5
	}
}

cpr_add_prostitute_traits_effect = {
	# Lifestyle Prostitute / XP
	add_trait = lifestyle_prostitute
	add_trait_xp = {
		trait = lifestyle_prostitute
		value = {
			integer_range = {
				min = small_lifestyle_random_xp_low
				max = small_lifestyle_random_xp_high
			}
		}
	}

	# Fornicator
	add_trait = fornicator

	# Poet
	random = {
		chance = 1
		modifier = {
			add = 10
			culture = { has_cultural_parameter = poet_trait_more_common }
		}
		add_trait = poet
	}

	# Lifestyle Reveler XP
	if = {
		limit = { has_trait = lifestyle_reveler }
		add_trait_xp = {
			trait = lifestyle_reveler
			value = {
				integer_range = {
					min = small_lifestyle_random_xp_low
					max = small_lifestyle_random_xp_high
				}
			}
		}
	}

	# Loyal / Disloyal, weight
	set_interesting_traits_and_modifiers_effect = yes
}

cpr_set_prostitute_sexuality_effect = {
	random_list = {
		5 = {
			set_sexuality = bisexual
		}
		5 = {
			trigger = {
				OR = {
					AND = {
						is_female = yes
						$CHARACTER$ = { is_female = yes }
					}
					AND = {
						is_male = yes
						$CHARACTER$ = { is_male = yes }
					}
				}
			}
			set_sexuality = homosexual
		}
		10 = {
			trigger = {
				OR = {
					AND = {
						is_female = no
						$CHARACTER$ = { is_female = yes }
					}
					AND = {
						is_male = no
						$CHARACTER$ = { is_male = yes }
					}
				}
			}
			set_sexuality = heterosexual
		}
	}
}

cpr_prostitute_contract_std_effect = {
	random_list = {
		94 = {}
		5 = {
			contract_disease_notify_effect = { DISEASE = lovers_pox }
		}
		1 = {
			contract_disease_notify_effect = { DISEASE = great_pox }
		}
	}
}

cpr_get_relevant_ruler_effect = {
	clear_saved_scope = $RULER$
	if = {
		limit = { is_ruler = yes }
		save_scope_as = $RULER$
	}
	else_if = {
		limit = { is_hostage = yes }
		warden = { save_scope_as = $RULER$ }
	}
	else_if = {
		limit = { is_foreign_court_or_pool_guest = yes }
		host = { save_scope_as = $RULER$ }
	}
	else_if = {
		limit = { is_courtier = yes }
		liege = { save_scope_as = $RULER$ }
	}
	else_if = {
		limit = {
			exists = location
			exists = location.county
		}
		location.county.holder ?= { save_scope_as = $RULER$ }
	}
}
